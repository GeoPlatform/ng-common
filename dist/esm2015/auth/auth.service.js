import * as tslib_1 from "tslib";
import { Inject, Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import { Config } from '@geoplatform/client';
import { RPMService } from '@geoplatform/rpm/src/iRPMService';
import { authServiceFactory } from './auth.factory';
import * as i0 from "@angular/core";
import * as i1 from "@geoplatform/rpm/src/iRPMService";
let AppAuthService = class AppAuthService {
    constructor(rpm) {
        this.observers = {};
        this.authService = authServiceFactory(Config);
        this.rpm = rpm;
        this.init();
    }
    init() {
        this.user$ = new Subject();
        if (!this.authService)
            return;
        const sub = this.authService.getMessenger().raw();
        this.gpAuthSubscription = sub.subscribe(msg => {
            // console.log("Received Auth Message: " + msg.name);
            switch (msg.name) {
                case 'userAuthenticated':
                    this.onUserChange(msg.user);
                    break;
                case 'userSignOut':
                    this.onUserChange(null);
                    break;
            }
        });
        this.authService.getUser().then(user => { this.onUserChange(user); });
    }
    onUserChange(user) {
        console.log("AuthService.onUserChange() : User is " + (user ? user.username : 'N/A'));
        this.user = user;
        // this.rpm.setUserId( user ? user.id : null);
        this.user$.next(user);
    }
    /**
     *
     */
    getMessenger() {
        return this.authService ? this.authService.getMessenger().raw() : null;
    }
    isAuthenticated() {
        return !!this.user;
    }
    getUser() {
        return this.user;
    }
    getToken() {
        return this.authService ? this.authService.getJWT() : null;
    }
    /**
     * Check the underlying authentication mechanism endpoint to validate the
     * current JWT token (if one exists) is not expired or revoked.
     * @return GeoPlatformUser or null
     */
    check() {
        if (!this.authService)
            return Promise.resolve(null);
        return this.authService.checkWithClient()
            .then(token => this.authService.getUser())
            .then(user => {
            setTimeout(() => { this.onUserChange(user); }, 100);
            return user;
        });
    }
    login() {
        this.authService.login();
    }
    logout() {
        this.authService.logout();
    }
    /**
     *
     */
    subscribe(callback) {
        return this.user$.subscribe(callback);
    }
    dispose() {
        if (this.gpAuthSubscription) {
            this.gpAuthSubscription.unsubscribe();
            this.gpAuthSubscription = null;
        }
        this.user = null;
        this.user$ = null;
        this.observers = null;
        this.authService = null;
    }
};
AppAuthService.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [RPMService,] }] }
];
AppAuthService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function AppAuthService_Factory() { return new AppAuthService(i0.ɵɵinject(i1.RPMService)); }, token: AppAuthService, providedIn: "root" });
AppAuthService = tslib_1.__decorate([
    Injectable({ providedIn: 'root' }),
    tslib_1.__param(0, Inject(RPMService))
], AppAuthService);
export { AppAuthService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGdlb3BsYXRmb3JtL2NvbW1vbi8iLCJzb3VyY2VzIjpbImF1dGgvYXV0aC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQXdCLE9BQU8sRUFBZ0IsTUFBTSxNQUFNLENBQUM7QUFDbkUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzdDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQTtBQU03RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7O0FBSXBELElBQWEsY0FBYyxHQUEzQixNQUFhLGNBQWM7SUFZdkIsWUFBaUMsR0FBZ0I7UUFSekMsY0FBUyxHQUNiLEVBQWlELENBQUM7UUFRbEQsSUFBSSxDQUFDLFdBQVcsR0FBRyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM5QyxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztRQUNmLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNoQixDQUFDO0lBR0QsSUFBSTtRQUVBLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxPQUFPLEVBQW1CLENBQUM7UUFFNUMsSUFBRyxDQUFDLElBQUksQ0FBQyxXQUFXO1lBQUUsT0FBTztRQUU3QixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ2xELElBQUksQ0FBQyxrQkFBa0IsR0FBRyxHQUFHLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQzFDLHFEQUFxRDtZQUNyRCxRQUFPLEdBQUcsQ0FBQyxJQUFJLEVBQUM7Z0JBQ1osS0FBSyxtQkFBbUI7b0JBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMs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QUFadEIsY0FBYztJQUQxQixVQUFVLENBQUMsRUFBQyxVQUFVLEVBQUUsTUFBTSxFQUFDLENBQUM7SUFhZixtQkFBQSxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUE7R0FadkIsY0FBYyxDQTBHMUI7U0ExR1ksY0FBYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgT2JzZXJ2ZXIsIFN1YmplY3QsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQ29uZmlnIH0gZnJvbSAnQGdlb3BsYXRmb3JtL2NsaWVudCc7XG5pbXBvcnQgeyBSUE1TZXJ2aWNlIH0gZnJvbSAnQGdlb3BsYXRmb3JtL3JwbS9zcmMvaVJQTVNlcnZpY2UnXG5cbmltcG9ydCB7XG4gICAgbmdHcG9hdXRoRmFjdG9yeSwgQXV0aFNlcnZpY2UsIEdlb1BsYXRmb3JtVXNlclxufSBmcm9tICdAZ2VvcGxhdGZvcm0vb2F1dGgtbmcvYW5ndWxhcic7XG5cbmltcG9ydCB7IGF1dGhTZXJ2aWNlRmFjdG9yeSB9IGZyb20gJy4vYXV0aC5mYWN0b3J5JztcblxuXG5ASW5qZWN0YWJsZSh7cHJvdmlkZWRJbjogJ3Jvb3QnfSlcbmV4cG9ydCBjbGFzcyBBcHBBdXRoU2VydmljZSB7XG5cbiAgICBwcml2YXRlIHVzZXIgOiBHZW9QbGF0Zm9ybVVzZXI7XG4gICAgcHJpdmF0ZSB1c2VyJCA6IFN1YmplY3Q8R2VvUGxhdGZvcm1Vc2VyPjtcbiAgICBwcml2YXRlIG9ic2VydmVycyA6IHsgW2tleTpzdHJpbmddOiBPYnNlcnZlcjxHZW9QbGF0Zm9ybVVzZXI+IH0gPVxuICAgICAgICB7fSBhcyB7IFtrZXk6c3RyaW5nXTogT2JzZXJ2ZXI8R2VvUGxhdGZvcm1Vc2VyPiB9O1xuICAgIHByaXZhdGUgZ3BBdXRoU3Vic2NyaXB0aW9uIDogU3Vic2NyaXB0aW9uO1xuICAgIHByaXZhdGUgYXV0aFNlcnZpY2UgOiBBdXRoU2VydmljZTtcbiAgICBwcml2YXRlIHJwbTogUlBNU2VydmljZTtcblxuXG5cbiAgICBjb25zdHJ1Y3RvciggQEluamVjdChSUE1TZXJ2aWNlKSBycG0gOiBSUE1TZXJ2aWNlICkge1xuICAgICAgICB0aGlzLmF1dGhTZXJ2aWNlID0gYXV0aFNlcnZpY2VGYWN0b3J5KENvbmZpZyk7XG4gICAgICAgIHRoaXMucnBtID0gcnBtO1xuICAgICAgICB0aGlzLmluaXQoKTtcbiAgICB9XG5cblxuICAgIGluaXQoKSB7XG5cbiAgICAgICAgdGhpcy51c2VyJCA9IG5ldyBTdWJqZWN0PEdlb1BsYXRmb3JtVXNlcj4oKTtcblxuICAgICAgICBpZighdGhpcy5hdXRoU2VydmljZSkgcmV0dXJuO1xuXG4gICAgICAgIGNvbnN0IHN1YiA9IHRoaXMuYXV0aFNlcnZpY2UuZ2V0TWVzc2VuZ2VyKCkucmF3KCk7XG4gICAgICAgIHRoaXMuZ3BBdXRoU3Vic2NyaXB0aW9uID0gc3ViLnN1YnNjcmliZShtc2cgPT4ge1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coXCJSZWNlaXZlZCBBdXRoIE1lc3NhZ2U6IFwiICsgbXNnLm5hbWUpO1xuICAgICAgICAgICAgc3dpdGNoKG1zZy5uYW1lKXtcbiAgICAgICAgICAgICAgICBjYXNlICd1c2VyQXV0aGVudGljYXRlZCc6IHRoaXMub25Vc2VyQ2hhbmdlKG1zZy51c2VyKTsgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSAndXNlclNpZ25PdXQnOiB0aGlzLm9uVXNlckNoYW5nZShudWxsKTsgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuYXV0aFNlcnZpY2UuZ2V0VXNlcigpLnRoZW4oIHVzZXIgPT4geyB0aGlzLm9uVXNlckNoYW5nZSh1c2VyKTsgfSk7XG5cbiAgICB9XG5cbiAgICBvblVzZXJDaGFuZ2UodXNlciA6IEdlb1BsYXRmb3JtVXNlcikge1xuICAgICAgICBjb25zb2xlLmxvZyhcIkF1dGhTZXJ2aWNlLm9uVXNlckNoYW5nZSgpIDogVXNlciBpcyBcIiArICh1c2VyID8gdXNlci51c2VybmFtZSA6ICdOL0EnKSk7XG4gICAgICAgIHRoaXMudXNlciA9IHVzZXI7XG4gICAgICAgIC8vIHRoaXMucnBtLnNldFVzZXJJZCggdXNlciA/IHVzZXIuaWQgOiBudWxsKTtcbiAgICAgICAgdGhpcy51c2VyJC5uZXh0KHVzZXIpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICovXG4gICAgZ2V0TWVzc2VuZ2VyKCkgOiBTdWJqZWN0PGFueT57XG4gICAgICAgIHJldHVybiB0aGlzLmF1dGhTZXJ2aWNlID8gdGhpcy5hdXRoU2VydmljZS5nZXRNZXNzZW5nZXIoKS5yYXcoKSA6IG51bGw7XG4gICAgfVxuXG5cbiAgICBpc0F1dGhlbnRpY2F0ZWQoKSA6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gISF0aGlzLnVzZXI7XG4gICAgfVxuXG4gICAgZ2V0VXNlcigpIDogR2VvUGxhdGZvcm1Vc2VyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudXNlcjtcbiAgICB9XG5cbiAgICBnZXRUb2tlbigpIDogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXV0aFNlcnZpY2UgPyB0aGlzLmF1dGhTZXJ2aWNlLmdldEpXVCgpIDogbnVsbDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVjayB0aGUgdW5kZXJseWluZyBhdXRoZW50aWNhdGlvbiBtZWNoYW5pc20gZW5kcG9pbnQgdG8gdmFsaWRhdGUgdGhlXG4gICAgICogY3VycmVudCBKV1QgdG9rZW4gKGlmIG9uZSBleGlzdHMpIGlzIG5vdCBleHBpcmVkIG9yIHJldm9rZWQuXG4gICAgICogQHJldHVybiBHZW9QbGF0Zm9ybVVzZXIgb3IgbnVsbFxuICAgICAqL1xuICAgIGNoZWNrKCkgOiBQcm9taXNlPEdlb1BsYXRmb3JtVXNlcj4ge1xuICAgICAgICBpZighdGhpcy5hdXRoU2VydmljZSkgcmV0dXJuIFByb21pc2UucmVzb2x2ZShudWxsKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXV0aFNlcnZpY2UuY2hlY2tXaXRoQ2xpZW50KClcbiAgICAgICAgLnRoZW4oIHRva2VuID0+IHRoaXMuYXV0aFNlcnZpY2UuZ2V0VXNlcigpIClcbiAgICAgICAgLnRoZW4oIHVzZXIgPT4ge1xuICAgICAgICAgICAgc2V0VGltZW91dCggKCkgPT4geyB0aGlzLm9uVXNlckNoYW5nZSh1c2VyKTsgfSwxMDAgKTtcbiAgICAgICAgICAgIHJldHVybiB1c2VyO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBsb2dpbigpIHtcbiAgICAgICAgdGhpcy5hdXRoU2VydmljZS5sb2dpbigpO1xuICAgIH1cblxuICAgIGxvZ291dCgpIHtcbiAgICAgICAgdGhpcy5hdXRoU2VydmljZS5sb2dvdXQoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqL1xuICAgIHN1YnNjcmliZSggY2FsbGJhY2sgOiBPYnNlcnZlcjxHZW9QbGF0Zm9ybVVzZXI+ICkgOiBTdWJzY3JpcHRpb24ge1xuICAgICAgICByZXR1cm4gdGhpcy51c2VyJC5zdWJzY3JpYmUoIGNhbGxiYWNrICk7XG4gICAgfVxuXG5cbiAgICBkaXNwb3NlKCkge1xuICAgICAgICBpZih0aGlzLmdwQXV0aFN1YnNjcmlwdGlvbikge1xuICAgICAgICAgICAgdGhpcy5ncEF1dGhTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgICAgIHRoaXMuZ3BBdXRoU3Vic2NyaXB0aW9uID0gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnVzZXIgPSBudWxsO1xuICAgICAgICB0aGlzLnVzZXIkID0gbnVsbDtcbiAgICAgICAgdGhpcy5vYnNlcnZlcnMgPSBudWxsO1xuICAgICAgICB0aGlzLmF1dGhTZXJ2aWNlID0gbnVsbDtcbiAgICB9XG59XG4iXX0=