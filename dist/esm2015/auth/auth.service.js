import * as tslib_1 from "tslib";
import { Inject, Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import { Config } from '@geoplatform/client';
import { RPMService } from '@geoplatform/rpm/src/iRPMService';
import { authServiceFactory } from './auth.factory';
import { logger } from "../logger";
import * as i0 from "@angular/core";
import * as i1 from "@geoplatform/rpm/src/iRPMService";
let AppAuthService = class AppAuthService {
    constructor(rpm) {
        this.observers = {};
        this.authService = authServiceFactory(Config);
        this.rpm = rpm;
        this.init();
    }
    init() {
        this.user$ = new Subject();
        if (!this.authService)
            return;
        const sub = this.authService.getMessenger().raw();
        this.gpAuthSubscription = sub.subscribe(msg => {
            logger.debug("Received Auth Message: " + msg.name);
            switch (msg.name) {
                case 'userAuthenticated':
                    this.onUserChange(msg.user);
                    break;
                case 'userSignOut':
                    this.onUserChange(null);
                    break;
            }
        });
        this.authService.getUser().then(user => { this.onUserChange(user); });
    }
    onUserChange(user) {
        logger.debug("AuthService.onUserChange() : User is " + (user ? user.username : 'N/A'));
        this.user = user;
        // this.rpm.setUserId( user ? user.id : null);
        this.user$.next(user);
    }
    /**
     *
     */
    getMessenger() {
        return this.authService ? this.authService.getMessenger().raw() : null;
    }
    isAuthenticated() {
        return !!this.user;
    }
    getUser() {
        return this.user;
    }
    getToken() {
        return this.authService ? this.authService.getJWT() : null;
    }
    /**
     * Check the underlying authentication mechanism endpoint to validate the
     * current JWT token (if one exists) is not expired or revoked.
     * @return GeoPlatformUser or null
     */
    check() {
        if (!this.authService)
            return Promise.resolve(null);
        return this.authService.checkWithClient()
            .then(token => this.authService.getUser())
            .then(user => {
            setTimeout(() => { this.onUserChange(user); }, 100);
            return user;
        });
    }
    login() {
        this.authService.login();
    }
    logout() {
        this.authService.logout();
    }
    /**
     *
     */
    subscribe(callback) {
        return this.user$.subscribe(callback);
    }
    dispose() {
        if (this.gpAuthSubscription) {
            this.gpAuthSubscription.unsubscribe();
            this.gpAuthSubscription = null;
        }
        this.user = null;
        this.user$ = null;
        this.observers = null;
        this.authService = null;
    }
};
AppAuthService.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [RPMService,] }] }
];
AppAuthService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function AppAuthService_Factory() { return new AppAuthService(i0.ɵɵinject(i1.RPMService)); }, token: AppAuthService, providedIn: "root" });
AppAuthService = tslib_1.__decorate([
    Injectable({ providedIn: 'root' }),
    tslib_1.__param(0, Inject(RPMService))
], AppAuthService);
export { AppAuthService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGdlb3BsYXRmb3JtL2NvbW1vbi8iLCJzb3VyY2VzIjpbImF1dGgvYXV0aC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQXdCLE9BQU8sRUFBZ0IsTUFBTSxNQUFNLENBQUM7QUFDbkUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzdDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQTtBQU03RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNwRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFDOzs7QUFLbkMsSUFBYSxjQUFjLEdBQTNCLE1BQWEsY0FBYztJQVl2QixZQUFpQyxHQUFnQjtRQVJ6QyxjQUFTLEdBQ2IsRUFBaUQsQ0FBQztRQVFsRCxJQUFJLENBQUMsV0FBVyxHQUFHLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzlDLElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDO1FBQ2YsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2hCLENBQUM7SUFHRCxJQUFJO1FBRUEsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLE9BQU8sRUFBbUIsQ0FBQztRQUU1QyxJQUFHLENBQUMsSUFBSSxDQUFDLFdBQVc7WUFBRSxPQUFPO1FBRTdCLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDbEQsSUFBSSxDQUFDLGtCQUFrQixHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDMUMsTUFBTSxDQUFDLEtBQUssQ0FBQyx5QkFBeUIsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDbkQsUUFBTyxHQUFHLENBQUMsSUFBSSxFQUFDO2dCQUNaLEtBQUssbUJBQW1CO29CQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUFDLE1BQU07Z0JBQzdELEtBQUssYUFBYTtvQkFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUFDLE1BQU07YUFDdEQ7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFFLElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRTNFLENBQUM7SUFFRCxZQUFZLENBQUMsSUFBc0I7UUFDL0IsTUFBTSxDQUFDLEtBQUssQ0FBQyx1Q0FBdUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUN2RixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQiw4Q0FBOEM7UUFDOUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDMUIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsWUFBWTtRQUNSLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0lBQzNFLENBQUM7SUFHRCxlQUFlO1FBQ1gsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztJQUN2QixDQUFDO0lBRUQsT0FBTztRQUNILE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQztJQUNyQixDQUFDO0lBRUQsUUFBUTtRQUNKLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0lBQy9ELENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsS0FBSztRQUNELElBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVztZQUFFLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNuRCxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsZUFBZSxFQUFFO2FBQ3hDLElBQUksQ0FBRSxLQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUU7YUFDM0MsSUFBSSxDQUFFLElBQUksQ0FBQyxFQUFFO1lBQ1YsVUFBVSxDQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUMsR0FBRyxDQUFFLENBQUM7WUFDckQsT0FBTyxJQUFJLENBQUM7UUFDaEIsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQsS0FBSztRQUNELElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDN0IsQ0FBQztJQUVELE1BQU07UUFDRixJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQzlCLENBQUM7SUFFRDs7T0FFRztJQUNILFNBQVMsQ0FBRSxRQUFvQztRQUMzQyxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFFLFFBQVEsQ0FBRSxDQUFDO0lBQzVDLENBQUM7SUFHRCxPQUFPO1FBQ0gsSUFBRyxJQUFJLENBQUMsa0JBQWtCLEVBQUU7WUFDeEIsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ3RDLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLENBQUM7U0FDbEM7UUFDRCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztRQUNsQixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztRQUN0QixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztJQUM1QixDQUFDO0NBQ0osQ0FBQTs7NENBOUZpQixNQUFNLFNBQUMsVUFBVTs7O0FBWnRCLGNBQWM7SUFEMUIsVUFBVSxDQUFDLEVBQUMsVUFBVSxFQUFFLE1BQU0sRUFBQyxDQUFDO0lBYWYsbUJBQUEsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFBO0dBWnZCLGNBQWMsQ0EwRzFCO1NBMUdZLGNBQWMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIE9ic2VydmVyLCBTdWJqZWN0LCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IENvbmZpZyB9IGZyb20gJ0BnZW9wbGF0Zm9ybS9jbGllbnQnO1xuaW1wb3J0IHsgUlBNU2VydmljZSB9IGZyb20gJ0BnZW9wbGF0Zm9ybS9ycG0vc3JjL2lSUE1TZXJ2aWNlJ1xuXG5pbXBvcnQge1xuICAgIG5nR3BvYXV0aEZhY3RvcnksIEF1dGhTZXJ2aWNlLCBHZW9QbGF0Zm9ybVVzZXJcbn0gZnJvbSAnQGdlb3BsYXRmb3JtL29hdXRoLW5nL2FuZ3VsYXInO1xuXG5pbXBvcnQgeyBhdXRoU2VydmljZUZhY3RvcnkgfSBmcm9tICcuL2F1dGguZmFjdG9yeSc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tIFwiLi4vbG9nZ2VyXCI7XG5cblxuXG5ASW5qZWN0YWJsZSh7cHJvdmlkZWRJbjogJ3Jvb3QnfSlcbmV4cG9ydCBjbGFzcyBBcHBBdXRoU2VydmljZSB7XG5cbiAgICBwcml2YXRlIHVzZXIgOiBHZW9QbGF0Zm9ybVVzZXI7XG4gICAgcHJpdmF0ZSB1c2VyJCA6IFN1YmplY3Q8R2VvUGxhdGZvcm1Vc2VyPjtcbiAgICBwcml2YXRlIG9ic2VydmVycyA6IHsgW2tleTpzdHJpbmddOiBPYnNlcnZlcjxHZW9QbGF0Zm9ybVVzZXI+IH0gPVxuICAgICAgICB7fSBhcyB7IFtrZXk6c3RyaW5nXTogT2JzZXJ2ZXI8R2VvUGxhdGZvcm1Vc2VyPiB9O1xuICAgIHByaXZhdGUgZ3BBdXRoU3Vic2NyaXB0aW9uIDogU3Vic2NyaXB0aW9uO1xuICAgIHByaXZhdGUgYXV0aFNlcnZpY2UgOiBBdXRoU2VydmljZTtcbiAgICBwcml2YXRlIHJwbTogUlBNU2VydmljZTtcblxuXG5cbiAgICBjb25zdHJ1Y3RvciggQEluamVjdChSUE1TZXJ2aWNlKSBycG0gOiBSUE1TZXJ2aWNlICkge1xuICAgICAgICB0aGlzLmF1dGhTZXJ2aWNlID0gYXV0aFNlcnZpY2VGYWN0b3J5KENvbmZpZyk7XG4gICAgICAgIHRoaXMucnBtID0gcnBtO1xuICAgICAgICB0aGlzLmluaXQoKTtcbiAgICB9XG5cblxuICAgIGluaXQoKSB7XG5cbiAgICAgICAgdGhpcy51c2VyJCA9IG5ldyBTdWJqZWN0PEdlb1BsYXRmb3JtVXNlcj4oKTtcblxuICAgICAgICBpZighdGhpcy5hdXRoU2VydmljZSkgcmV0dXJuO1xuXG4gICAgICAgIGNvbnN0IHN1YiA9IHRoaXMuYXV0aFNlcnZpY2UuZ2V0TWVzc2VuZ2VyKCkucmF3KCk7XG4gICAgICAgIHRoaXMuZ3BBdXRoU3Vic2NyaXB0aW9uID0gc3ViLnN1YnNjcmliZShtc2cgPT4ge1xuICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKFwiUmVjZWl2ZWQgQXV0aCBNZXNzYWdlOiBcIiArIG1zZy5uYW1lKTtcbiAgICAgICAgICAgIHN3aXRjaChtc2cubmFtZSl7XG4gICAgICAgICAgICAgICAgY2FzZSAndXNlckF1dGhlbnRpY2F0ZWQnOiB0aGlzLm9uVXNlckNoYW5nZShtc2cudXNlcik7IGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgJ3VzZXJTaWduT3V0JzogdGhpcy5vblVzZXJDaGFuZ2UobnVsbCk7IGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmF1dGhTZXJ2aWNlLmdldFVzZXIoKS50aGVuKCB1c2VyID0+IHsgdGhpcy5vblVzZXJDaGFuZ2UodXNlcik7IH0pO1xuXG4gICAgfVxuXG4gICAgb25Vc2VyQ2hhbmdlKHVzZXIgOiBHZW9QbGF0Zm9ybVVzZXIpIHtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKFwiQXV0aFNlcnZpY2Uub25Vc2VyQ2hhbmdlKCkgOiBVc2VyIGlzIFwiICsgKHVzZXIgPyB1c2VyLnVzZXJuYW1lIDogJ04vQScpKTtcbiAgICAgICAgdGhpcy51c2VyID0gdXNlcjtcbiAgICAgICAgLy8gdGhpcy5ycG0uc2V0VXNlcklkKCB1c2VyID8gdXNlci5pZCA6IG51bGwpO1xuICAgICAgICB0aGlzLnVzZXIkLm5leHQodXNlcik7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKi9cbiAgICBnZXRNZXNzZW5nZXIoKSA6IFN1YmplY3Q8YW55PntcbiAgICAgICAgcmV0dXJuIHRoaXMuYXV0aFNlcnZpY2UgPyB0aGlzLmF1dGhTZXJ2aWNlLmdldE1lc3NlbmdlcigpLnJhdygpIDogbnVsbDtcbiAgICB9XG5cblxuICAgIGlzQXV0aGVudGljYXRlZCgpIDogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAhIXRoaXMudXNlcjtcbiAgICB9XG5cbiAgICBnZXRVc2VyKCkgOiBHZW9QbGF0Zm9ybVVzZXIge1xuICAgICAgICByZXR1cm4gdGhpcy51c2VyO1xuICAgIH1cblxuICAgIGdldFRva2VuKCkgOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5hdXRoU2VydmljZSA/IHRoaXMuYXV0aFNlcnZpY2UuZ2V0SldUKCkgOiBudWxsO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrIHRoZSB1bmRlcmx5aW5nIGF1dGhlbnRpY2F0aW9uIG1lY2hhbmlzbSBlbmRwb2ludCB0byB2YWxpZGF0ZSB0aGVcbiAgICAgKiBjdXJyZW50IEpXVCB0b2tlbiAoaWYgb25lIGV4aXN0cykgaXMgbm90IGV4cGlyZWQgb3IgcmV2b2tlZC5cbiAgICAgKiBAcmV0dXJuIEdlb1BsYXRmb3JtVXNlciBvciBudWxsXG4gICAgICovXG4gICAgY2hlY2soKSA6IFByb21pc2U8R2VvUGxhdGZvcm1Vc2VyPiB7XG4gICAgICAgIGlmKCF0aGlzLmF1dGhTZXJ2aWNlKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG51bGwpO1xuICAgICAgICByZXR1cm4gdGhpcy5hdXRoU2VydmljZS5jaGVja1dpdGhDbGllbnQoKVxuICAgICAgICAudGhlbiggdG9rZW4gPT4gdGhpcy5hdXRoU2VydmljZS5nZXRVc2VyKCkgKVxuICAgICAgICAudGhlbiggdXNlciA9PiB7XG4gICAgICAgICAgICBzZXRUaW1lb3V0KCAoKSA9PiB7IHRoaXMub25Vc2VyQ2hhbmdlKHVzZXIpOyB9LDEwMCApO1xuICAgICAgICAgICAgcmV0dXJuIHVzZXI7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGxvZ2luKCkge1xuICAgICAgICB0aGlzLmF1dGhTZXJ2aWNlLmxvZ2luKCk7XG4gICAgfVxuXG4gICAgbG9nb3V0KCkge1xuICAgICAgICB0aGlzLmF1dGhTZXJ2aWNlLmxvZ291dCgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICovXG4gICAgc3Vic2NyaWJlKCBjYWxsYmFjayA6IE9ic2VydmVyPEdlb1BsYXRmb3JtVXNlcj4gKSA6IFN1YnNjcmlwdGlvbiB7XG4gICAgICAgIHJldHVybiB0aGlzLnVzZXIkLnN1YnNjcmliZSggY2FsbGJhY2sgKTtcbiAgICB9XG5cblxuICAgIGRpc3Bvc2UoKSB7XG4gICAgICAgIGlmKHRoaXMuZ3BBdXRoU3Vic2NyaXB0aW9uKSB7XG4gICAgICAgICAgICB0aGlzLmdwQXV0aFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgICAgICAgdGhpcy5ncEF1dGhTdWJzY3JpcHRpb24gPSBudWxsO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMudXNlciA9IG51bGw7XG4gICAgICAgIHRoaXMudXNlciQgPSBudWxsO1xuICAgICAgICB0aGlzLm9ic2VydmVycyA9IG51bGw7XG4gICAgICAgIHRoaXMuYXV0aFNlcnZpY2UgPSBudWxsO1xuICAgIH1cbn1cbiJdfQ==