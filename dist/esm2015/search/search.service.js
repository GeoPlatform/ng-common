import * as tslib_1 from "tslib";
import { Inject, Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import { ItemService } from '@geoplatform/client';
import { logger } from '../logger';
const INVALID_SUBJECT_ERROR = "SearchService implementation must create a valid Subject using SearchService.prototype.createSubject()";
/**
 * Abstract Search Service
 *
 * Base Search Service implementation which implements most of the interfaces
 * methods. The remaning methods are required to be implemented by specific
 * implementations of this class
 */
export class AbstractSearchService {
    constructor() {
        // protected results  : R;
        this._selected = [];
        this.subject = this.createSubject();
        if (!this.subject) {
            throw new Error(INVALID_SUBJECT_ERROR);
        }
        this.subject$ = this.subject.asObservable();
    }
    /**
     * Notify subscribers of a change to one or more pieces of managed data
     */
    emit(event) {
        this.subject.next(event);
    }
    getError() { return this._error; }
    setError(err) { this._error = err; }
    /**
     * Updates the query managed by this search service instance and optionally
     * triggers a refresh of search results using that query
     */
    setQuery(query, andSearch) {
        this._query = query;
        this.emit({ query: query });
        if (true === andSearch) {
            this.search();
        }
    }
    getQuery() { return this._query; }
    getResults() { return this._results; }
    setResults(results) { this._results = results; }
    /**
     * Toggle one or more items as selected
     */
    select(item) {
        if (Array.isArray(item)) { //multiple selections
            item.forEach(it => this._toggleItem(it, false));
            this.emit({ selected: this._selected });
            return;
        }
        this._toggleItem(item, true);
    }
    /**
     * Internal method which toggles an Item as selected (or de-selected if it
     * was already selected) and optionally triggers a notification of a change
     * in the selected items managed by this service instance
     */
    _toggleItem(item, fireEvent) {
        if (!item)
            return;
        let position = this._selected.findIndex((s) => this.compareItems(s, item));
        if (position >= 0) { //already selected, deselect it and return
            this._selected.splice(position, 1);
            if (fireEvent)
                this.emit({ selected: this._selected });
            return;
        }
        this._selected.push(item);
        this.sortItems(this._selected);
        if (fireEvent)
            this.emit({ selected: this._selected });
    }
    /**
     * @param item being checked for selection
     * @return boolean
     */
    isSelected(item) {
        return this._selected.length && item &&
            this._selected.findIndex((it) => this.compareItems(it, item)) >= 0;
    }
    /**
     * @return boolean true if there is one or more selected items
     */
    hasSelected() {
        return this._selected && this._selected.length > 0;
    }
    /**
     * @return array of selected items
     */
    getSelected() {
        return this._selected;
    }
    setSelected(sel) { this._selected = sel; }
    /**
     * De-selects all currently selected items
     */
    clearSelected() {
        this._selected = [];
        this.emit({ selected: this._selected });
    }
    /**
     * Registers a listener on this service's subject which will be notified
     * upon any change in managed data
     */
    subscribe(listener) {
        let obs = {
            next: (value) => {
                if (typeof (value) === 'undefined' || value === null)
                    return;
                if (value.query)
                    listener.onQueryChange(value.query);
                if (value.results)
                    listener.onResultsChange(value.results, value.error || null);
                if (value.selected)
                    listener.onSelectedChange(value.selected);
            },
            error: (err) => {
                console.log("[ERROR] " + err.message);
            },
            complete: () => { }
        };
        let sub = this.subject$.subscribe(obs);
        if (this._query) {
            this.emit({ query: this._query });
        }
        if (this._results || this._error) {
            this.emit({ results: this._results, error: this._error || null });
        }
        if (this._selected) {
            this.emit({ selected: this._selected });
        }
        return sub;
    }
}
/**
 * GeoPlatform Search Service
 *
 * Instance of SearchService which allows searching GeoPlatform Portfolio (RIM)
 * Items (Datasets, Maps, Layers, Services, etc)
 */
let GeoPlatformSearchService = class GeoPlatformSearchService extends AbstractSearchService {
    constructor(service) {
        super();
        this.service = service;
    }
    getService() { return this.service; }
    createSubject() {
        return new Subject();
    }
    /**
     *
     */
    getQuery() {
        return super.getQuery().clone();
    }
    // /**
    //  *
    //  */
    // setQuery(query : Query) {
    //     super.setQuery( query ? query.clone() : query );
    // }
    /**
     *
     */
    search(query) {
        //if a query was provided, store it and use it
        if (query)
            this.setQuery(query);
        this.service.search(super.getQuery())
            .then((response) => {
            logger.debug('SearchService.search() - ' + response.totalResults + " results found");
            this.setResults(response);
            this.setError(null);
            this.emit({ results: response, error: null });
        })
            .catch((error) => {
            logger.error(error.message);
            this.setError(error);
            this.emit({ results: null, error: error });
        });
    }
    /**
     *
     */
    _toggleItem(item, fireEvent) {
        if (!item || !item.id)
            return;
        let selected = this.getSelected();
        let position = selected.findIndex(s => s.id === item.id);
        if (position >= 0) { //already selected, deselect it and return
            selected.splice(position, 1);
            this.setSelected(selected);
            if (fireEvent)
                this.emit({ selected: selected });
            return;
        }
        //new selection
        // logger.error(`Selecting ${item.label} as ${entry.type.toString()}`);
        //fetch full object and replace placeholder in selected array
        this.service.get(item.id)
            .then(fullItem => {
            let selected = this.getSelected();
            selected.push(fullItem);
            this.sortItems(selected);
            this.setSelected(selected);
            if (fireEvent)
                this.emit({ selected: selected });
        })
            .catch(e => {
            logger.error("SearchService.select() - " +
                "Error encountered fetching selected item's details: " + e.message);
        });
    }
    compareItems(a, b) {
        return a.id === b.id;
    }
    sortItems(items) {
        items.sort((a, b) => a.label > b.label ? 1 : -1);
    }
};
GeoPlatformSearchService.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [ItemService,] }] }
];
GeoPlatformSearchService = tslib_1.__decorate([
    Injectable(),
    tslib_1.__param(0, Inject(ItemService))
], GeoPlatformSearchService);
export { GeoPlatformSearchService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZ2VvcGxhdGZvcm0vY29tbW9uLyIsInNvdXJjZXMiOlsic2VhcmNoL3NlYXJjaC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQXdCLE9BQU8sRUFBZ0IsTUFBTSxNQUFNLENBQUM7QUFDbkUsT0FBTyxFQUE4QixXQUFXLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUM5RSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBc0RuQyxNQUFNLHFCQUFxQixHQUFHLHdHQUF3RyxDQUFDO0FBRXZJOzs7Ozs7R0FNRztBQUNILE1BQU0sT0FBZ0IscUJBQXFCO0lBaUJ2QztRQVhBLDBCQUEwQjtRQUVsQixjQUFTLEdBQVEsRUFBRSxDQUFDO1FBVXhCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3BDLElBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ2QsTUFBTSxJQUFJLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1NBQzFDO1FBQ0QsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ2hELENBQUM7SUFvQkQ7O09BRUc7SUFDSSxJQUFJLENBQUUsS0FBaUM7UUFDMUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDN0IsQ0FBQztJQUVNLFFBQVEsS0FBYSxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQ3ZDLFFBQVEsQ0FBRSxHQUFXLElBQUssSUFBSSxDQUFDLE1BQU0sR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBRXhEOzs7T0FHRztJQUNJLFFBQVEsQ0FBQyxLQUFTLEVBQUUsU0FB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QixDQTBGcEM7U0ExRlksd0JBQXdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBPYnNlcnZlciwgU3ViamVjdCwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBJdGVtLCBRdWVyeSwgU2VhcmNoUmVzdWx0cywgSXRlbVNlcnZpY2UgfSBmcm9tICdAZ2VvcGxhdGZvcm0vY2xpZW50JztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uL2xvZ2dlcic7XG5cblxuLyoqXG4gKlxuICovXG5leHBvcnQgaW50ZXJmYWNlIFNlYXJjaFNlcnZpY2VFdmVudDxRLFIsST4ge1xuICAgIHF1ZXJ5ICAgID86IFE7XG4gICAgcmVzdWx0cyAgPzogUjtcbiAgICBzZWxlY3RlZCA/OiBJW107XG4gICAgZXJyb3IgICAgPzogRXJyb3I7XG59XG5cbi8qKlxuICpcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBHZW9QbGF0Zm9ybVNlYXJjaFNlcnZpY2VFdmVudCBleHRlbmRzIFNlYXJjaFNlcnZpY2VFdmVudDxRdWVyeSwgU2VhcmNoUmVzdWx0cywgSXRlbT4ge1xuXG59XG5cblxuLyoqXG4gKiBTZWFyY2ggQXdhcmUgQ29tcG9uZW50IEludGVyZmFjZVxuICpcbiAqIENvbXBvbmVudHMgd2hpY2ggaW1wbGVtZW50IHRoaXMgaW50ZXJmYWNlIGNhbiByZWNlaXZlIG5vdGlmaWNhdGlvbnMgd2hlbiB0aGVpclxuICogc3Vic2NyaWJlZC10byBTZWFyY2hTZXJ2aWNlIGltcGxlbWVudGF0aW9uIHRyaWdnZXIgY2hhbmdlcyB0byBxdWVyaWVzLFxuICogc2VhcmNoIHJlc3VsdHMsIGFuZCBzZWxlY3Rpb25zXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgU2VhcmNoQXdhcmVDb21wb25lbnQ8USxSLEk+IHtcbiAgICBvblF1ZXJ5Q2hhbmdlKCBxdWVyeSA6IFEgKSA6IHZvaWQ7XG4gICAgb25SZXN1bHRzQ2hhbmdlKCByZXN1bHRzIDogUiwgZXJyb3IgPzogRXJyb3IgKSA6IHZvaWQ7XG4gICAgb25TZWxlY3RlZENoYW5nZSggc2VsZWN0ZWQgOiBJW10gKSA6IHZvaWQ7XG59XG5cbi8qKlxuICogU2VhcmNoIFNlcnZpY2UgSW50ZXJmYWNlXG4gKlxuICogU2VydmljZXMgd2hpY2ggaW1wbGVtZW50IHRoaXMgaW50ZXJmYWNlIGNhbiBhY3QgYXMgZGF0YSBwcm92aWRlcnMgZm9yXG4gKiBTZWFyY2hBd2FyZUNvbXBvbmVudCBpbXBsZW1lbnRhdGlvbnNcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBTZWFyY2hTZXJ2aWNlPFEsUixJPiB7XG4gICAgc2V0UXVlcnkocXVlcnkgOiBRKTtcbiAgICBnZXRRdWVyeSgpIDogUTtcbiAgICBnZXRSZXN1bHRzKCkgOiBSO1xuICAgIHNlYXJjaChxdWVyeSA/OiBRKTtcbiAgICBzZWxlY3QoIGl0ZW0gOiBJfElbXSApO1xuICAgIGlzU2VsZWN0ZWQoIGl0ZW0gOiBJICkgOiBib29sZWFuO1xuICAgIGhhc1NlbGVjdGVkKCkgOiBib29sZWFuO1xuICAgIGdldFNlbGVjdGVkKCkgOiBJW107XG4gICAgY2xlYXJTZWxlY3RlZCgpO1xuICAgIHN1YnNjcmliZSggbGlzdGVuZXIgOiBTZWFyY2hBd2FyZUNvbXBvbmVudDxRLFIsST4gKSA6IFN1YnNjcmlwdGlvbjtcbn1cblxuXG5jb25zdCBJTlZBTElEX1NVQkpFQ1RfRVJST1IgPSBcIlNlYXJjaFNlcnZpY2UgaW1wbGVtZW50YXRpb24gbXVzdCBjcmVhdGUgYSB2YWxpZCBTdWJqZWN0IHVzaW5nIFNlYXJjaFNlcnZpY2UucHJvdG90eXBlLmNyZWF0ZVN1YmplY3QoKVwiO1xuXG4vKipcbiAqIEFic3RyYWN0IFNlYXJjaCBTZXJ2aWNlXG4gKlxuICogQmFzZSBTZWFyY2ggU2VydmljZSBpbXBsZW1lbnRhdGlvbiB3aGljaCBpbXBsZW1lbnRzIG1vc3Qgb2YgdGhlIGludGVyZmFjZXNcbiAqIG1ldGhvZHMuIFRoZSByZW1hbmluZyBtZXRob2RzIGFyZSByZXF1aXJlZCB0byBiZSBpbXBsZW1lbnRlZCBieSBzcGVjaWZpY1xuICogaW1wbGVtZW50YXRpb25zIG9mIHRoaXMgY2xhc3NcbiAqL1xuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEFic3RyYWN0U2VhcmNoU2VydmljZTxRLFIsST4gaW1wbGVtZW50cyBTZWFyY2hTZXJ2aWNlPFEsUixJPiB7XG5cbiAgICBwcml2YXRlIF9xdWVyeSA6IFE7XG4gICAgLy8gcHJvdGVjdGVkIHF1ZXJ5ICAgIDogUTtcblxuICAgIHByaXZhdGUgX3Jlc3VsdHMgOiBSO1xuICAgIC8vIHByb3RlY3RlZCByZXN1bHRzICA6IFI7XG5cbiAgICBwcml2YXRlIF9zZWxlY3RlZDogSVtdID0gW107XG4gICAgLy8gcHJvdGVjdGVkIHNlbGVjdGVkIDogSVtdID0gW107XG5cbiAgICBwcml2YXRlIF9lcnJvciA6IEVycm9yO1xuICAgIC8vIHByb3RlY3RlZCBlcnJvciAgICA6IEVycm9yO1xuXG4gICAgcHJvdGVjdGVkIHN1YmplY3QgOiBTdWJqZWN0PFNlYXJjaFNlcnZpY2VFdmVudDxRLFIsST4+O1xuICAgIHByb3RlY3RlZCBzdWJqZWN0JCA6IE9ic2VydmFibGU8U2VhcmNoU2VydmljZUV2ZW50PFEsUixJPj47XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy5zdWJqZWN0ID0gdGhpcy5jcmVhdGVTdWJqZWN0KCk7XG4gICAgICAgIGlmKCF0aGlzLnN1YmplY3QpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihJTlZBTElEX1NVQkpFQ1RfRVJST1IpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc3ViamVjdCQgPSB0aGlzLnN1YmplY3QuYXNPYnNlcnZhYmxlKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRmFjdG9yeSB0byBjcmVhdGUgdGhlIGludGVybmFsIHN1YmplY3QgdXNlZCB0byBub3RpZnkgc3Vic2NyaWJlcnMgdG9cbiAgICAgKiBjaGFuZ2VzIGluIHRoZSBkYXRhIHRoZSBzZWFyY2ggc2VydmljZSBpcyBtYW5hZ2luZy5cbiAgICAgKi9cbiAgICBwdWJsaWMgYWJzdHJhY3QgY3JlYXRlU3ViamVjdCgpIDogU3ViamVjdDxTZWFyY2hTZXJ2aWNlRXZlbnQ8USxSLEk+PjtcblxuICAgIC8qKlxuICAgICAqIFRyaWdnZXJzIGEgcXVlcnkgb2YgZGF0YSB1c2luZyBlaXRoZXIgdGhlIHN1cHBsaWVkIHF1ZXJ5IGluc3RhbmNlIG9yXG4gICAgICogdGhlIG1vc3QgcmVjZW50IG9uZSBtYW5hZ2VkIGJ5IHRoaXMgc2VydmljZVxuICAgICAqL1xuICAgIHB1YmxpYyBhYnN0cmFjdCBzZWFyY2gocXVlcnkgPzogUSk7XG5cbiAgICAvKiogTWV0aG9kIHRvIGNvbXBhcmUgdHdvIGl0ZW1zIGZvciBzaW1pbGFyaXR5ICovXG4gICAgcHJvdGVjdGVkIGFic3RyYWN0IGNvbXBhcmVJdGVtcyhhIDogSSwgYiA6IEkpIDogYm9vbGVhbjtcblxuICAgIC8qKiBNZXRob2QgdG8gc29ydCBzZWFyY2ggcmVzdWx0IGl0ZW1zICovXG4gICAgcHJvdGVjdGVkIGFic3RyYWN0IHNvcnRJdGVtcyggaXRlbXM6IElbXSApO1xuXG4gICAgLyoqXG4gICAgICogTm90aWZ5IHN1YnNjcmliZXJzIG9mIGEgY2hhbmdlIHRvIG9uZSBvciBtb3JlIHBpZWNlcyBvZiBtYW5hZ2VkIGRhdGFcbiAgICAgKi9cbiAgICBwdWJsaWMgZW1pdCggZXZlbnQgOiBTZWFyY2hTZXJ2aWNlRXZlbnQ8USxSLEk+ICkge1xuICAgICAgICB0aGlzLnN1YmplY3QubmV4dChldmVudCk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldEVycm9yKCkgOiBFcnJvciB7IHJldHVybiB0aGlzLl9lcnJvcjsgfVxuICAgIHByb3RlY3RlZCBzZXRFcnJvciggZXJyIDogRXJyb3IgKSB7IHRoaXMuX2Vycm9yID0gZXJyOyB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGVzIHRoZSBxdWVyeSBtYW5hZ2VkIGJ5IHRoaXMgc2VhcmNoIHNlcnZpY2UgaW5zdGFuY2UgYW5kIG9wdGlvbmFsbHlcbiAgICAgKiB0cmlnZ2VycyBhIHJlZnJlc2ggb2Ygc2VhcmNoIHJlc3VsdHMgdXNpbmcgdGhhdCBxdWVyeVxuICAgICAqL1xuICAgIHB1YmxpYyBzZXRRdWVyeShxdWVyeSA6IFEsIGFuZFNlYXJjaCA/OiBib29sZWFuKSB7XG4gICAgICAgIHRoaXMuX3F1ZXJ5ID0gcXVlcnk7XG4gICAgICAgIHRoaXMuZW1pdCh7IHF1ZXJ5IDogcXVlcnkgfSk7XG5cbiAgICAgICAgaWYoIHRydWUgPT09IGFuZFNlYXJjaCApIHtcbiAgICAgICAgICAgIHRoaXMuc2VhcmNoKCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHVibGljIGdldFF1ZXJ5KCkgOiBRIHsgcmV0dXJuIHRoaXMuX3F1ZXJ5OyB9XG5cbiAgICBwdWJsaWMgZ2V0UmVzdWx0cygpIDogUiB7IHJldHVybiB0aGlzLl9yZXN1bHRzOyB9XG4gICAgcHJvdGVjdGVkIHNldFJlc3VsdHMoIHJlc3VsdHMgOiBSICkgeyB0aGlzLl9yZXN1bHRzID0gcmVzdWx0czsgfVxuXG4gICAgLyoqXG4gICAgICogVG9nZ2xlIG9uZSBvciBtb3JlIGl0ZW1zIGFzIHNlbGVjdGVkXG4gICAgICovXG4gICAgcHVibGljIHNlbGVjdCggaXRlbSA6IEl8SVtdICkge1xuICAgICAgICBpZihBcnJheS5pc0FycmF5KGl0ZW0pKSB7IC8vbXVsdGlwbGUgc2VsZWN0aW9uc1xuICAgICAgICAgICAgaXRlbS5mb3JFYWNoKCBpdCA9PiB0aGlzLl90b2dnbGVJdGVtKGl0LCBmYWxzZSkgKTtcbiAgICAgICAgICAgIHRoaXMuZW1pdCh7IHNlbGVjdGVkOiB0aGlzLl9zZWxlY3RlZCB9KTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl90b2dnbGVJdGVtKCBpdGVtLCB0cnVlICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSW50ZXJuYWwgbWV0aG9kIHdoaWNoIHRvZ2dsZXMgYW4gSXRlbSBhcyBzZWxlY3RlZCAob3IgZGUtc2VsZWN0ZWQgaWYgaXRcbiAgICAgKiB3YXMgYWxyZWFkeSBzZWxlY3RlZCkgYW5kIG9wdGlvbmFsbHkgdHJpZ2dlcnMgYSBub3RpZmljYXRpb24gb2YgYSBjaGFuZ2VcbiAgICAgKiBpbiB0aGUgc2VsZWN0ZWQgaXRlbXMgbWFuYWdlZCBieSB0aGlzIHNlcnZpY2UgaW5zdGFuY2VcbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgX3RvZ2dsZUl0ZW0oIGl0ZW0gOiBJLCBmaXJlRXZlbnQgOiBib29sZWFuICkge1xuICAgICAgICBpZighaXRlbSkgcmV0dXJuO1xuICAgICAgICBsZXQgcG9zaXRpb24gPSB0aGlzLl9zZWxlY3RlZC5maW5kSW5kZXgoIChzOkkpID0+IHRoaXMuY29tcGFyZUl0ZW1zKHMsIGl0ZW0pICk7XG4gICAgICAgIGlmKHBvc2l0aW9uID49IDApIHsgLy9hbHJlYWR5IHNlbGVjdGVkLCBkZXNlbGVjdCBpdCBhbmQgcmV0dXJuXG4gICAgICAgICAgICB0aGlzLl9zZWxlY3RlZC5zcGxpY2UocG9zaXRpb24sIDEpO1xuICAgICAgICAgICAgaWYoZmlyZUV2ZW50KSB0aGlzLmVtaXQoe3NlbGVjdGVkOiB0aGlzLl9zZWxlY3RlZH0pO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX3NlbGVjdGVkLnB1c2goaXRlbSk7XG4gICAgICAgIHRoaXMuc29ydEl0ZW1zKHRoaXMuX3NlbGVjdGVkKTtcbiAgICAgICAgaWYoZmlyZUV2ZW50KSB0aGlzLmVtaXQoe3NlbGVjdGVkOiB0aGlzLl9zZWxlY3RlZH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSBpdGVtIGJlaW5nIGNoZWNrZWQgZm9yIHNlbGVjdGlvblxuICAgICAqIEByZXR1cm4gYm9vbGVhblxuICAgICAqL1xuICAgIHB1YmxpYyBpc1NlbGVjdGVkKCBpdGVtIDogSSApOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3NlbGVjdGVkLmxlbmd0aCAmJiBpdGVtICYmXG4gICAgICAgICAgICB0aGlzLl9zZWxlY3RlZC5maW5kSW5kZXgoIChpdDpJKSA9PiB0aGlzLmNvbXBhcmVJdGVtcyhpdCwgaXRlbSkgKSA+PSAwO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEByZXR1cm4gYm9vbGVhbiB0cnVlIGlmIHRoZXJlIGlzIG9uZSBvciBtb3JlIHNlbGVjdGVkIGl0ZW1zXG4gICAgICovXG4gICAgcHVibGljIGhhc1NlbGVjdGVkKCkgOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3NlbGVjdGVkICYmIHRoaXMuX3NlbGVjdGVkLmxlbmd0aCA+IDA7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHJldHVybiBhcnJheSBvZiBzZWxlY3RlZCBpdGVtc1xuICAgICAqL1xuICAgIHB1YmxpYyBnZXRTZWxlY3RlZCgpIDogSVtdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3NlbGVjdGVkO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgc2V0U2VsZWN0ZWQoIHNlbCA6IElbXSApIHsgdGhpcy5fc2VsZWN0ZWQgPSBzZWw7IH1cblxuICAgIC8qKlxuICAgICAqIERlLXNlbGVjdHMgYWxsIGN1cnJlbnRseSBzZWxlY3RlZCBpdGVtc1xuICAgICAqL1xuICAgIHB1YmxpYyBjbGVhclNlbGVjdGVkKCkge1xuICAgICAgICB0aGlzLl9zZWxlY3RlZCA9IFtdO1xuICAgICAgICB0aGlzLmVtaXQoeyBzZWxlY3RlZDogdGhpcy5fc2VsZWN0ZWQgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVnaXN0ZXJzIGEgbGlzdGVuZXIgb24gdGhpcyBzZXJ2aWNlJ3Mgc3ViamVjdCB3aGljaCB3aWxsIGJlIG5vdGlmaWVkXG4gICAgICogdXBvbiBhbnkgY2hhbmdlIGluIG1hbmFnZWQgZGF0YVxuICAgICAqL1xuICAgIHB1YmxpYyBzdWJzY3JpYmUoIGxpc3RlbmVyIDogU2VhcmNoQXdhcmVDb21wb25lbnQ8USxSLEk+ICkgOiBTdWJzY3JpcHRpb24ge1xuXG4gICAgICAgIGxldCBvYnMgOiBPYnNlcnZlcjxTZWFyY2hTZXJ2aWNlRXZlbnQ8USxSLEk+PiA9IHtcbiAgICAgICAgICAgIG5leHQgOiAodmFsdWU6IFNlYXJjaFNlcnZpY2VFdmVudDxRLFIsST4pID0+IHtcbiAgICAgICAgICAgICAgICBpZiggdHlwZW9mKHZhbHVlKSA9PT0gJ3VuZGVmaW5lZCcgfHwgdmFsdWUgPT09IG51bGwpIHJldHVybjtcbiAgICAgICAgICAgICAgICBpZih2YWx1ZS5xdWVyeSlcbiAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXIub25RdWVyeUNoYW5nZSggdmFsdWUucXVlcnkgKTtcbiAgICAgICAgICAgICAgICBpZih2YWx1ZS5yZXN1bHRzKVxuICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lci5vblJlc3VsdHNDaGFuZ2UoIHZhbHVlLnJlc3VsdHMsIHZhbHVlLmVycm9yfHxudWxsICk7XG4gICAgICAgICAgICAgICAgaWYodmFsdWUuc2VsZWN0ZWQpXG4gICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyLm9uU2VsZWN0ZWRDaGFuZ2UoIHZhbHVlLnNlbGVjdGVkICk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZXJyb3IgOiAoIGVycjogRXJyb3IgKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJbRVJST1JdIFwiICsgZXJyLm1lc3NhZ2UpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGNvbXBsZXRlIDogKCkgPT4geyB9XG4gICAgICAgIH07XG5cbiAgICAgICAgbGV0IHN1YiA9IHRoaXMuc3ViamVjdCQuc3Vic2NyaWJlKCBvYnMgKTtcblxuICAgICAgICBpZih0aGlzLl9xdWVyeSkge1xuICAgICAgICAgICAgdGhpcy5lbWl0KHsgcXVlcnkgOiB0aGlzLl9xdWVyeSB9KTtcbiAgICAgICAgfVxuICAgICAgICBpZih0aGlzLl9yZXN1bHRzIHx8IHRoaXMuX2Vycm9yKSB7XG4gICAgICAgICAgICB0aGlzLmVtaXQoeyByZXN1bHRzIDogdGhpcy5fcmVzdWx0cywgZXJyb3I6IHRoaXMuX2Vycm9yfHxudWxsIH0pO1xuICAgICAgICB9XG4gICAgICAgIGlmKHRoaXMuX3NlbGVjdGVkKSB7XG4gICAgICAgICAgICB0aGlzLmVtaXQoeyBzZWxlY3RlZCA6IHRoaXMuX3NlbGVjdGVkIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHN1YjtcbiAgICB9XG5cbn1cblxuXG5cblxuXG5cblxuLyoqXG4gKiBHZW9QbGF0Zm9ybSBTZWFyY2ggU2VydmljZVxuICpcbiAqIEluc3RhbmNlIG9mIFNlYXJjaFNlcnZpY2Ugd2hpY2ggYWxsb3dzIHNlYXJjaGluZyBHZW9QbGF0Zm9ybSBQb3J0Zm9saW8gKFJJTSlcbiAqIEl0ZW1zIChEYXRhc2V0cywgTWFwcywgTGF5ZXJzLCBTZXJ2aWNlcywgZXRjKVxuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgR2VvUGxhdGZvcm1TZWFyY2hTZXJ2aWNlIGV4dGVuZHMgQWJzdHJhY3RTZWFyY2hTZXJ2aWNlPFF1ZXJ5LCBTZWFyY2hSZXN1bHRzLCBJdGVtPntcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBASW5qZWN0KEl0ZW1TZXJ2aWNlKSBwcml2YXRlIHNlcnZpY2UgOiBJdGVtU2VydmljZVxuICAgICkge1xuICAgICAgICBzdXBlcigpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBnZXRTZXJ2aWNlKCkgOiBJdGVtU2VydmljZSB7IHJldHVybiB0aGlzLnNlcnZpY2U7IH1cblxuICAgIGNyZWF0ZVN1YmplY3QoKSA6IFN1YmplY3Q8U2VhcmNoU2VydmljZUV2ZW50PFF1ZXJ5LFNlYXJjaFJlc3VsdHMsSXRlbT4+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBTdWJqZWN0PFNlYXJjaFNlcnZpY2VFdmVudDxRdWVyeSxTZWFyY2hSZXN1bHRzLEl0ZW0+PigpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICovXG4gICAgZ2V0UXVlcnkoKSA6IFF1ZXJ5IHtcbiAgICAgICAgcmV0dXJuIHN1cGVyLmdldFF1ZXJ5KCkuY2xvbmUoKTtcbiAgICB9XG5cbiAgICAvLyAvKipcbiAgICAvLyAgKlxuICAgIC8vICAqL1xuICAgIC8vIHNldFF1ZXJ5KHF1ZXJ5IDogUXVlcnkpIHtcbiAgICAvLyAgICAgc3VwZXIuc2V0UXVlcnkoIHF1ZXJ5ID8gcXVlcnkuY2xvbmUoKSA6IHF1ZXJ5ICk7XG4gICAgLy8gfVxuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKi9cbiAgICBzZWFyY2gocXVlcnkgPzogUXVlcnkpIHtcbiAgICAgICAgLy9pZiBhIHF1ZXJ5IHdhcyBwcm92aWRlZCwgc3RvcmUgaXQgYW5kIHVzZSBpdFxuICAgICAgICBpZihxdWVyeSkgdGhpcy5zZXRRdWVyeShxdWVyeSk7XG5cbiAgICAgICAgdGhpcy5zZXJ2aWNlLnNlYXJjaCggc3VwZXIuZ2V0UXVlcnkoKSApXG4gICAgICAgIC50aGVuKCAocmVzcG9uc2UgOiBTZWFyY2hSZXN1bHRzKSA9PiB7XG4gICAgICAgICAgICBsb2dnZXIuZGVidWcoJ1NlYXJjaFNlcnZpY2Uuc2VhcmNoKCkgLSAnICsgcmVzcG9uc2UudG90YWxSZXN1bHRzICsgXCIgcmVzdWx0cyBmb3VuZFwiKTtcbiAgICAgICAgICAgIHRoaXMuc2V0UmVzdWx0cyhyZXNwb25zZSk7XG4gICAgICAgICAgICB0aGlzLnNldEVycm9yKG51bGwpO1xuICAgICAgICAgICAgdGhpcy5lbWl0KHsgcmVzdWx0cyA6IHJlc3BvbnNlLCBlcnJvcjogbnVsbCB9KTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKCAoZXJyb3IgOiBFcnJvcikgPT4ge1xuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGVycm9yLm1lc3NhZ2UpO1xuICAgICAgICAgICAgdGhpcy5zZXRFcnJvcihlcnJvcik7XG4gICAgICAgICAgICB0aGlzLmVtaXQoeyByZXN1bHRzIDogbnVsbCwgZXJyb3I6IGVycm9yIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cblxuICAgIC8qKlxuICAgICAqXG4gICAgICovXG4gICAgX3RvZ2dsZUl0ZW0oIGl0ZW0gOiBJdGVtLCBmaXJlRXZlbnQgOiBib29sZWFuICkge1xuICAgICAgICBpZighaXRlbSB8fCAhaXRlbS5pZCkgcmV0dXJuO1xuICAgICAgICBsZXQgc2VsZWN0ZWQgPSB0aGlzLmdldFNlbGVjdGVkKCk7XG4gICAgICAgIGxldCBwb3NpdGlvbiA9IHNlbGVjdGVkLmZpbmRJbmRleCggcyA9PiBzLmlkID09PSBpdGVtLmlkICk7XG4gICAgICAgIGlmKHBvc2l0aW9uID49IDApIHsgLy9hbHJlYWR5IHNlbGVjdGVkLCBkZXNlbGVjdCBpdCBhbmQgcmV0dXJuXG4gICAgICAgICAgICBzZWxlY3RlZC5zcGxpY2UocG9zaXRpb24sIDEpO1xuICAgICAgICAgICAgdGhpcy5zZXRTZWxlY3RlZChzZWxlY3RlZCk7XG4gICAgICAgICAgICBpZihmaXJlRXZlbnQpIHRoaXMuZW1pdCh7c2VsZWN0ZWQ6IHNlbGVjdGVkfSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICAvL25ldyBzZWxlY3Rpb25cbiAgICAgICAgLy8gbG9nZ2VyLmVycm9yKGBTZWxlY3RpbmcgJHtpdGVtLmxhYmVsfSBhcyAke2VudHJ5LnR5cGUudG9TdHJpbmcoKX1gKTtcblxuICAgICAgICAvL2ZldGNoIGZ1bGwgb2JqZWN0IGFuZCByZXBsYWNlIHBsYWNlaG9sZGVyIGluIHNlbGVjdGVkIGFycmF5XG4gICAgICAgIHRoaXMuc2VydmljZS5nZXQoaXRlbS5pZClcbiAgICAgICAgLnRoZW4oIGZ1bGxJdGVtID0+IHtcbiAgICAgICAgICAgIGxldCBzZWxlY3RlZCA9IHRoaXMuZ2V0U2VsZWN0ZWQoKTtcbiAgICAgICAgICAgIHNlbGVjdGVkLnB1c2goZnVsbEl0ZW0pO1xuICAgICAgICAgICAgdGhpcy5zb3J0SXRlbXMoc2VsZWN0ZWQpO1xuICAgICAgICAgICAgdGhpcy5zZXRTZWxlY3RlZChzZWxlY3RlZCk7XG4gICAgICAgICAgICBpZihmaXJlRXZlbnQpIHRoaXMuZW1pdCh7c2VsZWN0ZWQ6IHNlbGVjdGVkfSk7XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaChlID0+IHtcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihcIlNlYXJjaFNlcnZpY2Uuc2VsZWN0KCkgLSBcIiArXG4gICAgICAgICAgICAgICAgXCJFcnJvciBlbmNvdW50ZXJlZCBmZXRjaGluZyBzZWxlY3RlZCBpdGVtJ3MgZGV0YWlsczogXCIgKyBlLm1lc3NhZ2UpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBjb21wYXJlSXRlbXMoYSA6IEl0ZW0sIGIgOiBJdGVtKSA6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gYS5pZCA9PT0gYi5pZDtcbiAgICB9XG5cbiAgICBzb3J0SXRlbXMoIGl0ZW1zOiBJdGVtW10gKSB7XG4gICAgICAgIGl0ZW1zLnNvcnQoKGEsYikgPT4gYS5sYWJlbCA+IGIubGFiZWwgPyAxIDogLTEgKTtcbiAgICB9XG5cbn1cbiJdfQ==